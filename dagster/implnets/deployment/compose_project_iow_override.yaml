version: "3.9"

# DO NOT START IN PYCHARM (unless you set the env variables in your runconfig
# USE:
# ./docker_eco_prod_start.h
services:
    dagster-dagit:
            # GLEANEERIO_  the environment variables for this stack, passed into containers
            # the variables passed into the containers varies due to inconsistent standards.
            # this there are prefixed by project aka ECRR_ for customization
          # DO NOT RENAME THE FIRST PART, aka the container environment variable,
          #     unless you sure what you are doing
        environment: &env
            - DEBUG_CONTAINER=${DEBUG_CONTAINER:-false}
            - GLEANERIO_CONFIG_PATH=${GLEANERIO_CONFIG_PATH:-scheduler/configs/test/}
            - GLEANERIO_DAGSTER_CONFIG_PATH=${GLEANERIO_DAGSTER_CONFIG_PATH:-scheduler/logs/}
            - GLEANERIO_DOCKER_CONTAINER_WAIT_TIMEOUT=${IOW_DOCKER_CONTAINER_WAIT_TIMEOUT:-300}
            - GLEANERIO_DOCKER_GLEANER_CONFIG=${IOW_DOCKER_GLEANER_CONFIG:-gleaner}
            - GLEANERIO_DOCKER_HEADLESS_NETWORK=${GLEANERIO_DOCKER_HEADLESS_NETWORK}
            - GLEANERIO_DOCKER_NABU_CONFIG=${IOW_DOCKER_NABU_CONFIG:-nabu}
            - GLEANERIO_DOCKER_URL=${IOW_DOCKER_URL}
            - GLEANERIO_DOCKER_WORKSPACE_CONFIG=${IOW_DOCKER_WORKSPACE_CONFIG}
            - GLEANERIO_GLEANER_CONFIG_PATH=${GLEANERIO_GLEANER_CONFIG_PATH:-/configs/gleaner/gleanerconfig.yaml}
            - GLEANERIO_GLEANER_IMAGE=${IOW_GLEANER_IMAGE}
            - GLEANERIO_GRAPH_SUMMARIZE=${IOW_GRAPH_SUMMARIZE:-false}
            - GLEANERIO_GRAPH_SUMMARY_ENDPOINT=${IOW_GRAPH_SUMMARY_ENDPOINT:-${GLEANERIO_GRAPH_URL}}
            - GLEANERIO_GRAPH_SUMMARY_NAMESPACE=${IOW_GRAPH_SUMMARY_NAMESPACE}
            - GLEANERIO_GRAPH_URL=${IOW_GRAPH_URL}
            - GLEANERIO_HEADLESS_ENDPOINT=${GLEANERIO_HEADLESS_ENDPOINT}
            - GLEANERIO_LOG_PREFIX=${GLEANERIO_LOG_PREFIX:-scheduler/logs/}
            - GLEANERIO_MINIO_ACCESS_KEY=${IOW_MINIO_ACCESS_KEY}
            - GLEANERIO_MINIO_ADDRESS=${IOW_MINIO_ADDRESS}
            - GLEANERIO_MINIO_BUCKET=${IOW_MINIO_BUCKET}
            - GLEANERIO_MINIO_PORT=${IOW_MINIO_PORT}
            - GLEANERIO_MINIO_SECRET_KEY=${IOW_MINIO_SECRET_KEY}
            - GLEANERIO_MINIO_USE_SSL=${IOW_MINIO_USE_SSL}
            - GLEANERIO_NABU_CONFIG_PATH=${GLEANERIO_NABU_CONFIG_PATH:-/configs/gleaner/nabuconfig.yaml}
            - GLEANERIO_NABU_IMAGE=${IOW_NABU_IMAGE}
            - GLEANERIO_PORTAINER_APIKEY=${IOW_PORTAINER_APIKEY}
            - GLEANERIO_DEFAULT_SCHEDULE=${IOW_DEFAULT_SCHEDULE:-@weekly}
            - GLEANERIO_DEFAULT_SCHEDULE_TIMEZONE=${IOW_DEFAULT_SCHEDULE_TIMEZONE:-America/Los_Angeles}
            - GLEANERIO_SOURCES_FILENAME=${IOW_SOURCES_FILENAME:-gleanerconfig.yaml}
            - GLEANERIO_TENANT_FILENAME=${IOW_TENANT_FILENAME:-tenant.yaml}
            - GLEANERIO_WORKSPACE_CONFIG_PATH=${GLEANERIO_WORKSPACE_CONFIG_PATH}
            - PROTOCOL_BUFFERS_PYTHON_IMPLEMENTATION=python
            - SLACK_CHANNEL=${IOW_SLACK_CHANNEL:-"#twitterfeed"}
            - SLACK_TOKEN=${IOW_SLACK_TOKEN}


 #        command:
#            - "dagster-webserver"
#            - "-w"
#            - "workspace.yaml"
#            - "-h"
#            - "0.0.0.0"
#            - "-p"
#            - "3000"
        depends_on: &deps
            -   dagster-code-iow-ingest
            - dagster-code-tasks

    dagster-daemon:
        environment: *env
# portainer issue, merging commandsmay need to create a combined customised on
#        command:
#        - "dagster-daemon"
#        - "run"
#        - "-w"
#        - "workspace.yaml"
        depends_on:
            - dagster-postgres
            -   dagster-code-iow-ingest
            - dagster-code-tasks
        networks:
            - traefik_proxy
## GRPC servers are not just serving the code
# they need to compile it, so same image for all dagster-*
    dagster-code-iow-ingest:

        #        build:
        #          #context: .
        #          context: ..
        #          dockerfile: build/Dockerfile_code
        #          args:
        #            implnet: ${PROJECT:-eco}
        # you should be able to change the source locally, without a full rebuild.
        #image: dagster-${PROJECT:-eco}:latest
        image: docker.io/nsfearthcube/dagster-gleanerio-workflows:${CONTAINER_CODE_TAG:-latest}

        environment: *env
        command:
            - "dagster"
            - "api"
            - "grpc"
            - "-h"
            - "0.0.0.0"
            - "-p"
            - "4000"
            - "-m"
            - "workflows.ingest.ingest"
            - "-d"
            - "/usr/src/app/"

        volumes: &codevol
            - dagster-storage:/usr/src/app/storage
        depends_on:
            - dagster-postgres
        networks:
            - dagster_host


